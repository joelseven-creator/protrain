<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProTrain | Elite Cloud Tracker</title>
    <style>
        :root { --primary: #3b82f6; --success: #10b981; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --border: #334155; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 10px; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 10px; }
        #auth-container { text-align: center; padding-top: 100px; height: 100vh; }
        .hidden { display: none !important; }
        .user-info { font-size: 0.8rem; margin-bottom: 15px; color: #94a3b8; display: flex; justify-content: space-between; align-items: center; }
        .planner-form { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; align-items: end; border: 1px solid var(--border); }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 0.75rem; color: #94a3b8; }
        input, select, .btn { background: #334155; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; font-size: 14px; }
        .btn { cursor: pointer; font-weight: bold; border: none; transition: 0.2s; }
        .btn-primary { background: var(--primary); }
        .btn-accent { background: #f59e0b; color: #000; margin-bottom: 20px; width: 100%; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .day-column { background: var(--card); border-radius: 8px; padding: 10px; min-height: 250px; border: 1px solid var(--border); }
        .day-header { text-align: center; font-weight: bold; padding-bottom: 8px; border-bottom: 2px solid var(--primary); margin-bottom: 10px; }
        .workout-card { background: #334155; padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 0.8rem; position: relative; border-left: 4px solid var(--primary); }
        .workout-card.completed { border-left-color: var(--success); opacity: 0.5; text-decoration: line-through; }
        .delete-btn { position: absolute; top: 5px; right: 5px; color: #ef4444; background: none; border: none; cursor: pointer; }
        @media (max-width: 800px) { .calendar-grid { grid-template-columns: 1fr; } .planner-form { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="auth-container">
    <h1>âš¡ ProTrain Elite</h1>
    <p>Connectez-vous pour accÃ©der Ã  votre cloud d'entraÃ®nement.</p>
    <button class="btn btn-primary" id="login-btn" style="padding: 15px 30px; font-size: 1.1rem;">Se connecter avec Google</button>
</div>

<div id="app-container" class="hidden">
    <div class="container">
        <div class="user-info">
            <span>ðŸ‘¤ <span id="user-email"></span></span>
            <button id="logout-btn" class="btn" style="background:none; color:#ef4444; padding:0;">DÃ©connexion</button>
        </div>
        <div class="planner-form">
            <div class="input-group"><label>Jour</label><select id="day"><option value="0">Lun</option><option value="1">Mar</option><option value="2">Mer</option><option value="3">Jeu</option><option value="4">Ven</option><option value="5">Sam</option><option value="6">Dim</option></select></div>
            <div class="input-group"><label>Sport</label><select id="sport"><option value="ðŸƒ Run">Course</option><option value="ðŸš´ Bike">VÃ©lo</option><option value="ðŸ’ª Gym">Muscu</option><option value="ðŸ§˜ Core">Gainage</option></select></div>
            <div class="input-group"><label>DÃ©tails</label><input type="text" id="type" placeholder="ex: HIIT"></div>
            <div class="input-group"><label>DurÃ©e (min)</label><input type="number" id="duration" placeholder="60"></div>
            <button class="btn btn-primary" id="add-btn">Ajouter</button>
        </div>
        <button class="btn btn-accent" id="copy-btn">ðŸ”„ Copier le plan vers la semaine suivante</button>
        <div class="calendar-grid" id="calendar"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
    import { getAuth, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB5BUiC-k9Is9C1ASkjE-M3QSoKS52YzhI",
        authDomain: "training-app-99d94.firebaseapp.com",
        projectId: "training-app-99d94",
        storageBucket: "training-app-99d94.firebasestorage.app",
        messagingSenderId: "230722568164",
        appId: "1:230722568164:web:842ee5a6ebcc6cc83211f1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let workouts = [];
    let currentUser = null;
    let unsubscribe = null;

    // 1. Persistance et gestion du retour Google
    setPersistence(auth, browserLocalPersistence);
    getRedirectResult(auth).catch(err => console.error("Erreur redirection:", err));

    // 2. Ã‰vÃ©nements de connexion
    document
