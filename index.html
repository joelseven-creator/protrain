<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProTrain | Elite Cloud Tracker</title>
    <style>
        :root { --primary: #3b82f6; --success: #10b981; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --border: #334155; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 10px; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 10px; }
        #auth-container { text-align: center; padding-top: 100px; }
        .hidden { display: none !important; }
        .user-info { font-size: 0.8rem; margin-bottom: 15px; color: #94a3b8; display: flex; justify-content: space-between; align-items: center; }
        
        /* Form Styling */
        .planner-form { background: var(--card); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; align-items: end; border: 1px solid var(--border); }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 0.75rem; color: #94a3b8; }
        input, select, .btn { background: #334155; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; font-size: 14px; }
        .btn { cursor: pointer; font-weight: bold; border: none; }
        .btn-primary { background: var(--primary); }
        .btn-accent { background: #f59e0b; color: #000; margin-bottom: 20px; width: 100%; }

        /* Calendar Styling */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .day-column { background: var(--card); border-radius: 8px; padding: 10px; min-height: 250px; border: 1px solid var(--border); }
        .day-header { text-align: center; font-weight: bold; padding-bottom: 8px; border-bottom: 2px solid var(--primary); margin-bottom: 10px; }
        .workout-card { background: #334155; padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 0.8rem; position: relative; border-left: 4px solid var(--primary); }
        .workout-card.completed { border-left-color: var(--success); opacity: 0.5; text-decoration: line-through; }
        .delete-btn { position: absolute; top: 5px; right: 5px; color: #ef4444; background: none; border: none; cursor: pointer; }

        @media (max-width: 800px) { .calendar-grid { grid-template-columns: 1fr; } .planner-form { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="auth-container">
    <h1>âš¡ ProTrain Elite</h1>
    <p>Please sign in to access your training cloud.</p>
    <button class="btn btn-primary" id="login-btn">Sign in with Google</button>
</div>

<div id="app-container" class="hidden">
    <div class="container">
        <div class="user-info">
            <span>ðŸ‘¤ <span id="user-email"></span></span>
            <button id="logout-btn" class="btn" style="background:none; color:#ef4444; padding:0;">Logout</button>
        </div>

        <div class="planner-form">
            <div class="input-group">
                <label>Day</label>
                <select id="day">
                    <option value="0">Monday</option><option value="1">Tuesday</option><option value="2">Wednesday</option>
                    <option value="3">Thursday</option><option value="4">Friday</option><option value="5">Saturday</option><option value="6">Sunday</option>
                </select>
            </div>
            <div class="input-group">
                <label>Sport</label>
                <select id="sport">
                    <option value="ðŸƒ Run">Running</option><option value="ðŸš´ Bike">Bike</option><option value="ðŸ’ª Muscle">Musculation</option><option value="ðŸ§˜ Core">Core</option>
                </select>
            </div>
            <div class="input-group">
                <label>Intensity</label>
                <input type="text" id="type" placeholder="e.g. HIIT">
            </div>
            <div class="input-group">
                <label>Mins</label>
                <input type="number" id="duration" placeholder="60">
            </div>
            <button class="btn btn-primary" onclick="addWorkout()">Add Session</button>
        </div>

        <button class="btn btn-accent" onclick="copyToNextWeek()">ðŸ”„ Copy Plan to Next Week</button>
        <div class="calendar-grid" id="calendar"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB5BUiC-k9Is9C1ASkjE-M3QSoKS52YzhI",
        authDomain: "training-app-99d94.firebaseapp.com",
        projectId: "training-app-99d94",
        storageBucket: "training-app-99d94.firebasestorage.app",
        messagingSenderId: "230722568164",
        appId: "1:230722568164:web:842ee5a6ebcc6cc83211f1",
        measurementId: "G-MTWKT6JZWX"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let workouts = [];
    let unsubscribe = null;

    // 1. FIRST: Check your imports at the very top of your script. 
// Make sure "signInWithRedirect" is included in the list:
import { getAuth, signInWithRedirect, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

// 2. THEN: Replace your AUTH section with this:

// --- AUTH ---
  // We use window.login so the HTML button can definitely "see" it
  window.login = async () => {
      console.log("Attempting Login...");
      try {
          // This will move the whole page to Google's login screen
          await signInWithRedirect(auth, provider);
      } catch (error) {
          console.error("Login Error:", error);
          alert("Login failed: " + error.message);
      }
  };

  document.getElementById('login-btn').onclick = window.login;
  document.getElementById('logout-btn').onclick = () => signOut(auth);

  onAuthStateChanged(auth, (user) => {
      if (user) {
          currentUser = user;
          document.getElementById('auth-container').classList.add('hidden');
          document.getElementById('app-container').classList.remove('hidden');
          document.getElementById('user-email').innerText = user.email;
          startSync();
      } else {
          currentUser = null;
          if (unsubscribe) unsubscribe();
          document.getElementById('auth-container').classList.remove('hidden');
          document.getElementById('app-container').classList.add('hidden');
      }
  });

    // --- CLOUD LOGIC ---
    function startSync() {
        const q = query(collection(db, "trainings"), where("userId", "==", currentUser.uid));
        unsubscribe = onSnapshot(q, (snapshot) => {
            workouts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            render();
        });
    }

    window.addWorkout = async function() {
        const day = parseInt(document.getElementById('day').value);
        const sport = document.getElementById('sport').value;
        const type = document.getElementById('type').value;
        const duration = document.getElementById('duration').value;
        if(!type || !duration) return alert("Fill details!");

        await addDoc(collection(db, "trainings"), {
            userId: currentUser.uid, day, sport, type, duration, completed: false, createdAt: Date.now()
        });
        document.getElementById('type').value = '';
        document.getElementById('duration').value = '';
    };

    window.toggleComplete = async function(id) {
        const w = workouts.find(item => item.id === id);
        await updateDoc(doc(db, "trainings", id), { completed: !w.completed });
    };

    window.removeWorkout = async function(id) {
        if(confirm("Delete?")) await deleteDoc(doc(db, "trainings", id));
    };

    window.copyToNextWeek = async function() {
        if(!confirm("Copy all to next week?")) return;
        const batch = writeBatch(db);
        workouts.forEach(w => {
            const newRef = doc(collection(db, "trainings"));
            const {id, ...data} = w;
            batch.set(newRef, { ...data, completed: false, createdAt: Date.now() });
        });
        await batch.commit();
    };

    function render() {
        const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
        const calendar = document.getElementById('calendar');
        calendar.innerHTML = '';
        days.forEach((dayName, index) => {
            const col = document.createElement('div');
            col.className = 'day-column';
            col.innerHTML = `<div class="day-header">${dayName}</div>`;
            const dayWorkouts = workouts.filter(w => w.day === index).sort((a,b) => a.createdAt - b.createdAt);
            dayWorkouts.forEach(w => {
                const card = document.createElement('div');
                card
